<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/paper-slider/paper-slider.html">
<link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="bower_components/paper-material/paper-material.html">
<link rel="import" href="bower_components/iron-icons/iron-icons.html">
<link rel="import" href="bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<script type="text/javascript" src="../src/unroller.js"></script>

<!--
`display-element`


@demo demo/index.html 
-->

<dom-module id="display-element">
  <template>
    <style include="iron-flex iron-flex-alignment"></style>
    <style>
      :host {
        display: block;
      }
      #scaleSlider {
        --paper-slider-input: width: 60px;
        width: 300px;
      }
    </style>
    
    <div class="layout vertical center">
      
      <div class="layout vertical">
        <span>Graph Size</span>
        <paper-slider value="{{graphSize}}" max="32" id="scaleSlider" editable pin></paper-slider>
        <div class="layout horizontal center">
          <paper-icon-button raised id="snapButton" icon="save">SnapShot</paper-icon-button>
          <div class="layout flex"></div>
          <paper-icon-button raised id="clearButton" icon="clear">Clear</paper-icon-button>
        </div>
      </div>
      
      <paper-material id="canvasMaterial" elevation="3" style="width: {{displaySize}}px; height: {{displaySize}}px;" >
        <canvas id="theCanvas" width="[[displaySize]]" height="[[displaySize]]"></canvas>
      </paper-material>
    </div>
  </template>

  <script>
    Polymer({

      is: 'display-element',

      properties: {
        graphSize: {
          type: Number,
          value: 8,
        },
        displaySize: {
          type: Number,
          value: 300,
          notify: true,
        },
        scale: {
          type: Number,
          notify: true,
          computed: '_calculateDisplayScale(graphSize, displaySize)',
        },
        map: {
          type: Object,
        },
        drawing: false,
        lastCell: {
          type: Object,
          value: {'x':-1, 'y':-1, 'time': 0},
        },
      },
      listeners: {
        'scaleSlider.change': '_onScaleChange',
        'snapButton.tap': '_onSnapshot',
        'clearButton.tap': '_onClear',
        'theCanvas.track': '_onDrawMove',
        'theCanvas.down': '_onDrawStart',
        'theCanvas.up': '_onDrawEnd',
      },
      ready: function(){
        this.ctx = this.$.theCanvas.getContext('2d');
        this.resize();
        this.draw();
      },
      resize: function(){
        if(this.ctx === undefined) return;
        console.log("resizing");
        
        this.map = new FiniteGraph(this.graphSize);
        this.map.ident();
        
        console.log("new map: ", this.map);
        this.graphSize = this.map.width;
      },
      draw: function(){
        // clear canvas
        this.ctx.clearRect(0, 0, this.displaySize, this.displaySize);
        
        // redraw map
        this.ctx.width = this.ctx.width;
        for( var i=0; i<this.map.cells.length; i++ ){
            if(this.map.cells[i].data) this.ctx.fillRect(this.map.cells[i].x * this.scale, this.map.cells[i].y * this.scale, this.scale, this.scale);
        }
      },
      _onScaleChange: function(e){
         this.resize();
         this.draw();
      },
      _calculateDisplayScale: function(gs, ds){
        if(gs <= ds) return (ds/gs);
        else return 1;
      },
      toggleCell: function(e){
        // scale down to graphSize
        var pos = this.toGraphCoords(e);
        
        var offset = pos.x*this.graphSize+pos.y;
        
        // prevent flickering
        if( this.lastCell.x == pos.x && 
            this.lastCell.y == pos.y &&
            this.drawing ){
          return;
        }
        
        // toggle cell value
        if( this.map.cells[offset].data == 1 ) 
          this.map.cells[offset].data = 0;
        else 
          this.map.cells[offset].data = 1;
        
        // save state
        this.lastCell = {'x': pos.x, 'y': pos.y, 'time': e.timeStamp};
        this.draw();
      },
      toGraphCoords: function(e){
        var pos = {
          'x':Math.floor((e.detail.x - this.$.canvasMaterial.offsetLeft)/this.scale),
          'y':Math.floor((e.detail.y - this.$.canvasMaterial.offsetTop)/this.scale)
        };
        
        // keep in bounds
        if( pos.x < 0 ) pos.x = 0;
        if( pos.y < 0 ) pos.y = 0;
        if( pos.x > this.graphSize-1 ) pos.x = this.graphSize-1;
        if( pos.y > this.graphSize-1 ) pos.y = this.graphSize-1;

        return pos;
      },
      _onSnapshot: function(e){
        console.log(this.$.theCanvas.toDataURL());
      },
      _onClear: function(e){
        this.map.fill(0);
        this.draw();
      },
      _onDrawMove: function(e){
        if( e.detail.state == 'track' ){
          this.toggleCell(e);
        }
      },
      _onDrawStart: function(e){
        this.drawing = true;
        this.toggleCell(e);
      },
      _onDrawEnd: function(e){
        this.drawing = false;
      }
    });
  </script>
</dom-module>
